# هندسة النظام - عَقِلْها

## نظرة عامة

نظام عَقِلْها مبني على معمارية حديثة وقابلة للتوسع باستخدام Next.js 14 مع App Router.

## المعمارية الكاملة

```
┌─────────────────────────────────────────────────────────────┐
│                    مزودو خدمات الاتصالات                      │
│              (بيانات مجمعة ومجهولة فقط)                        │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│        1. وحدة استقبال البيانات (Data Ingestion)            │
│              - استقبال Real-time                              │
│              - التحقق من الصحة                                │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  2. طبقة إخفاء الهوية والتجميع (Anonymization Layer)        │
│              - k-anonymity (≥30)                            │
│              - حذف المعرّفات                                 │
│              - منع المناطق منخفضة الكثافة                    │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│    3. محرك التحليل المروري (Traffic Intelligence Core)      │
│              - كثافة الأجهزة/كم                              │
│              - متوسط السرعة                                  │
│              - مؤشر الازدحام (0-100)                        │
│              - زمن التأخير (دقائق)                          │
└──────────────────────┬──────────────────────────────────────┘
                       │
        ┌──────────────┴──────────────┐
        ▼                             ▼
┌──────────────────────┐    ┌──────────────────────┐
│ 4. كشف نقطة انطلاق   │    │ 5. محرك التنبؤ الذكي │
│    الازدحام          │    │    - 5, 10, 30, 60 د  │
│    - هبوط السرعة     │    │    - نماذج زمنية      │
│    - الامتداد الخلفي │    │    - تعلم آلي         │
└──────────────────────┘    │    - موسمية           │
                             └──────────────────────┘
        │                             │
        └──────────────┬──────────────┘
                       ▼
┌─────────────────────────────────────────────────────────────┐
│     6. محرك القرار المروري (Traffic Decision Engine)        │
│              - تحويلات مرورية                               │
│              - تدخلات تشغيلية                               │
│              - ضبط إشارات                                   │
│              - حساب التأثير                                  │
└──────────────────────┬──────────────────────────────────────┘
                       │
        ┌──────────────┴──────────────┐
        ▼                             ▼
┌──────────────────────┐    ┌──────────────────────┐
│ 7. الإشارات الذكية   │    │ 8. واجهة الطوارئ     │
│    - توصيات التوقيت  │    │    - مسار أسرع        │
│    - التكامل         │    │    - تحديث حي         │
└──────────────────────┘    └──────────────────────┘
        │                             │
        └──────────────┬──────────────┘
                       ▼
┌─────────────────────────────────────────────────────────────┐
│        9. التكامل مع أبشر وتطبيقات الملاحة                  │
│              - تنبيهات للسائقين                            │
│              - فتح المسارات                                 │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│        10. لوحة القيادة الوطنية                             │
│              - خريطة المملكة                               │
│              - تلوين الطرق                                  │
│              - تنبيهات حية                                   │
│              - تقييم التأثير                                │
└─────────────────────────────────────────────────────────────┘
```

## الوحدات الرئيسية

## الوحدات الرئيسية

### 1. وحدة استقبال البيانات (Data Ingestion Layer)
- **الموقع**: `app/api/ingestion/route.ts`
- **الوظيفة**: استقبال بيانات مجمعة من مزودي الاتصالات
- **المميزات**:
  - دعم Real-time processing
  - التحقق من صحة البيانات (Zod)
  - معالجة Streams

### 2. طبقة إخفاء الهوية والتجميع (Anonymization Layer)
- **الموقع**: `lib/core/anonymization.ts`
- **الوظيفة**: حذف المعرّفات وتطبيق k-anonymity
- **المميزات**:
  - k-anonymity ≥ 30
  - رفض تلقائي للبيانات منخفضة الكثافة
  - منع إعادة تحديد الهوية

### 3. محرك التحليل المروري (Traffic Intelligence Core)
- **الموقع**: `lib/core/traffic-intelligence.ts`
- **الوظيفة**: تحليل بيانات المرور
- **المخرجات**:
  - كثافة الأجهزة/كم
  - متوسط السرعة
  - مؤشر الازدحام (0-100)
  - زمن التأخير (دقائق)

### 4. كشف نقطة انطلاق الازدحام (Bottleneck Detection)
- **الموقع**: `lib/core/bottleneck-detection.ts`
- **الوظيفة**: تحديد نقطة أول هبوط حاد في السرعة
- **المميزات**:
  - كشف تلقائي
  - ربط الامتداد الخلفي
  - تحديد مستوى الخطورة

### 5. محرك التنبؤ الذكي (Prediction Engine)
- **الموقع**: `lib/core/prediction-engine.ts`
- **الوظيفة**: التنبؤ بالازدحام قبل حدوثه
- **الأطر الزمنية**: 5, 10, 30, 60 دقيقة
- **النماذج**:
  - نماذج زمنية (5-10 د)
  - تعلم آلي (10-30 د)
  - تحليل موسمية (30-60 د)

### 6. محرك القرار المروري (Decision Engine)
- **الموقع**: `lib/core/decision-engine.ts`
- **الوظيفة**: اقتراح قرارات مرورية
- **أنواع القرارات**:
  - تحويلات مرورية
  - تدخلات تشغيلية
  - ضبط إشارات
- **المميزات**:
  - حساب التأثير
  - اختيار أفضل قرار

### 7. وحدة الإشارات الذكية (Adaptive Signals)
- **الموقع**: `lib/core/adaptive-signals.ts`
- **الوظيفة**: توصيات زمن الإشارة
- **المميزات**:
  - ضبط تلقائي للتوقيت
  - التكامل مع النظام الإشاري
  - حساب التأثير المتوقع

### 8. واجهة الطوارئ (Emergency Routing)
- **الموقع**: `lib/core/emergency-routing.ts`
- **الوظيفة**: حساب المسار الأسرع
- **المميزات**:
  - تحديث حي كل 30 ثانية
  - تجنب الازدحام
  - حساب الوقت المتوقع

### 9. التكامل مع أبشر
- **الموقع**: `components/AbesherIntegration.tsx`
- **الوظيفة**: إرسال تنبيهات وتوجيهات
- **المميزات**:
  - تنبيهات فورية
  - فتح المسارات في تطبيقات الملاحة
  - عدم استيراد بيانات خارجية

### 10. لوحة القيادة الوطنية
- **الموقع**: `app/government/page.tsx`
- **الوظيفة**: نظرة شاملة للمسؤولين
- **المميزات**:
  - خريطة المملكة
  - تلوين الطرق
  - تنبيهات حية
  - تقييم التأثير

## المكونات التقنية

### Frontend
- **Next.js 14** مع App Router
- **React 18** مع TypeScript
- **Tailwind CSS** للتصميم
- **Leaflet** للخرائط
- **Recharts** للرسوم البيانية
- **React Query** لإدارة البيانات

### Backend
- **Next.js API Routes** (Serverless)
- **PostgreSQL** قاعدة البيانات
- **Prisma ORM** لإدارة البيانات
- **Zod** للتحقق من البيانات

### قاعدة البيانات
- **PostgreSQL** مع Prisma
- **الجداول**:
  - `RoadSegment`: مقاطع الطرق
  - `TrafficData`: بيانات المرور المجمعة
  - `Prediction`: تنبؤات الازدحام
  - `Bottleneck`: نقاط الازدحام
  - `TrafficDecision`: القرارات المرورية
  - `SignalRecommendation`: توصيات الإشارات
  - `EmergencyRoute`: مسارات الطوارئ
  - `Alert`: التنبيهات
  - `PrivacyAudit`: سجلات الخصوصية
  - `KPI`: مؤشرات الأداء
  - `UsageStats`: إحصائيات الاستخدام

## تدفق البيانات

```
مزودو الخدمة (بيانات مجهولة)
    ↓
طبقة التجميع (Ingestion Layer)
    ↓
قاعدة البيانات (PostgreSQL)
    ↓
API Routes (Next.js)
    ↓
Frontend (React Components)
    ↓
المستخدم / الحكومة
```

## الأمان والخصوصية

1. **البيانات المجهولة**: لا يتم تخزين أي هوية شخصية
2. **التجميع**: البيانات تأتي مجمعة من مزودي الخدمة
3. **التحقق**: Zod للتحقق من صحة البيانات
4. **CORS**: إعدادات CORS محددة

## التكامل مع أبشر

- **API Integration**: واجهات برمجية للتكامل مع أبشر
- **Push Notifications**: إشعارات للمستخدمين
- **SSO**: تسجيل دخول موحد (يمكن إضافته)

## الأداء

- **Server-Side Rendering**: Next.js SSR
- **Static Generation**: للصفحات الثابتة
- **Caching**: React Query caching
- **Image Optimization**: Next.js Image Optimization
- **Code Splitting**: تلقائي مع Next.js

## التوسع المستقبلي

1. **Real-time Updates**: Socket.io للبيانات الحية
2. **Machine Learning**: نماذج تنبؤية متقدمة
3. **Mobile Apps**: تطبيقات أصلية (React Native)
4. **Analytics**: تحليلات متقدمة
5. **Multi-language**: دعم لغات إضافية

